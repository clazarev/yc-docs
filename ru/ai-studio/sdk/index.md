# {{ ml-sdk-full-name }}

{{ ai-studio-full-name }} предоставляет библиотеку инструментов и примеров готового кода для разработки продуктов на языке Python — {{ ml-sdk-full-name }}. {{ ml-sdk-name }} обеспечивает стандартизированный способ взаимодействия с фундаментальными моделями и упрощает интеграцию с другими сервисами {{ yandex-cloud }}.

Библиотека {{ ml-sdk-name }} реализует синхронный и асинхронный интерфейсы Python на основе gRPC-вызовов API сервисов {{ ai-studio-name }}. В {{ ml-sdk-name }} доступны следующие возможности:
* [генерация текста и изображений](../concepts/generation/index.md) с помощью всех поддерживаемых [моделей](../concepts/generation/models.md);
* работа с [эмбеддингами](../concepts/embeddings.md);
* работа с [классификаторами на базе {{ yagpt-name }}](../concepts/classifier/index.md);
* создание [AI-ассистентов](../concepts/assistant/index.md);
* [дообучение](../concepts/tuning/index.md) моделей генерации текста и классификаторов;
* интеграция с [LangСhain](https://www.langchain.com/).

Полный перечень поддерживаемых функций, исходный код библиотеки и примеры использования доступны на [GitHub](https://github.com/yandex-cloud/yandex-cloud-ml-sdk).

## Установка {#install}

Установить библиотеку {{ ml-sdk-name }} можно с помощью менеджера пакетов [pip](https://pip.pypa.io/en/stable/):

```bash
pip install yandex-cloud-ml-sdk
```

## Аутентификация в {{ ml-sdk-full-name }} {#authentication}

Аутентификация в {{ ml-sdk-full-name }} выполняется путем передачи в модель объекта `YCloudML`, который содержит поля:

* `folder_id` — [идентификатор каталога](../../resource-manager/operations/folder/get-id.md), в котором вы будете работать с моделями.
* `auth` — ключ, токен или другие данные для аутентификации, позволяющие идентифицировать субъекта. Значение поля `auth` может быть задано явно или получено автоматически из окружения:

    {% list tabs %}

    - Значение задано явно

      Заданное явно значение поля `auth` может принимать одно из значений:

      * `string` — в форме строки можно передать:
          * [IAM-токен](../../iam/concepts/authorization/iam-token.md) пользовательского или [сервисного аккаунта](../../iam/concepts/users/service-accounts.md);
          * секретную часть [API-ключа](../../iam/concepts/authorization/api-key.md) сервисного аккаунта;
          * [OAuth-токен](../../iam/concepts/authorization/oauth-token.md) пользовательского аккаунта.

          SDK автоматически определит тип аутентификационных данных.
      * Объект одного из следующих классов:

          * `APIKeyAuth` — позволяет явно задать аутентификацию по передаваемому API-ключу. Например: `auth = APIKeyAuth('<API_ключ>')`.
          * `IAMTokenAuth` — позволяет явно задать аутентификацию по передаваемому IAM-токену. Например: `auth = IAMTokenAuth('<IAM-токен>')`.
          * `OAuthTokenAuth` — позволяет явно задать аутентификацию по передаваемому OAuth-токену. Например: `auth = OAuthTokenAuth('<OAuth-токен>')`.
          * `MetadataAuth` — позволяет явно задать аутентификацию от имени сервисного аккаунта, заданного в [метаданных](../../compute/concepts/vm-metadata.md) виртуальной машины {{ compute-full-name }}. Например: `auth = MetadataAuth()`.
          * `EnvIAMTokenAuth` — позволяет явно задать аутентификацию по IAM-токену, заданному в переменной окружения `YC_TOKEN` или любой другой. Например: `auth = EnvIAMTokenAuth()` или `auth = EnvIAMTokenAuth("ENV_VAR")`.

              SDK при каждом запросе заново получает IAM-токен из этой переменной окружения, поэтому вы можете вне SDK самостоятельно периодически обновлять IAM-токен в переменной окружения. Этот вариант аутентификации является оптимальным для использования с [сервисным агентом](../../datasphere/operations/community/create-ssa.md) в {{ ml-platform-full-name }}, если для этого сервиса включен [доступ](../../iam/concepts/service-control.md) к другим ресурсам в облаке пользователя.                
          * `YandexCloudCLIAuth` — позволяет явно задать аутентификацию от имени [пользователя](../../iam/concepts/users/accounts.md) или сервисного аккаунта, [заданного](../../cli/operations/index.md#auth) в профиле [{{ yandex-cloud }} CLI](../../cli/index.yaml) на компьютере пользователя. Например: `auth = YandexCloudCLIAuth()`.
          * `NoAuth` — позволяет указать, что аутентификационные данные не будут передаваться. Например: `auth = NoAuth()`.

          Эти классы вы можете получить, импортировав из библиотеки ML SDK. Например:

          ```python
          from yandex_cloud_ml_sdk.auth import APIKeyAuth
          ```

    - Значение получено из окружения

      Если поле `auth` явно не задано, то SDK автоматически попытается выбрать один из вариантов аутентификации в следующем порядке:

      1. Если задана переменная окружения `YC_API_KEY`, для аутентификации будет использован указанный в ней API-ключ.
      1. Если задана переменная окружения `YC_IAM_TOKEN`, для аутентификации будет использован указанный в ней IAM-токен.
      1. Если задана переменная окружения `YC_OAUTH_TOKEN`, для аутентификации будет использован переданный в ней OAuth-токен.
      1. Если такие переменные окружения не заданы, SDK попытается выполнить аутентификацию по IAM-токену сервисного аккаунта, заданного в метаданных виртуальной машины.
      1. Если задана переменная окружения `YC_TOKEN`, для аутентификации будет использован указанный в ней IAM-токен.

          SDK при каждом запросе заново получает IAM-токен из этой переменной окружения, поэтому вы можете вне SDK самостоятельно периодически обновлять IAM-токен в переменной окружения `YC_TOKEN`.
      1. Если предыдущие варианты не сработали, SDK попытается выполнить аутентификацию по IAM-токену [пользователя](../../iam/concepts/users/accounts.md) или сервисного аккаунта, [заданного](../../cli/operations/index.md#auth) в профиле [{{ yandex-cloud }} CLI](../../cli/index.yaml) на компьютере пользователя.

    {% endlist %}

    {% note info %}

    [Время жизни](../../iam/concepts/authorization/iam-token.md#lifetime) IAM-токена — не более 12 часов. Учитывайте это, выполняя запросы с аутентификацией по IAM-токену, заданному в строке, объекте класса `IAMTokenAuth` или переменной окружения `YC_IAM_TOKEN`.

    {% endnote %}

## Использование {#usage}

В качестве входных данных для запроса {{ ml-sdk-name }} может принимать:

* Строку. Например: `Что такое небо?`.
* Словарь — структуру данных, аналогичную [JSON](https://ru.wikipedia.org/wiki/JSON). Например: `{"role": "role", "text": "text"}`.
* Объект [класса](https://github.com/yandex-cloud/yandex-cloud-ml-sdk/blob/master/src/yandex_cloud_ml_sdk/_models/completions/message.py) `TextMessage` {{ ml-sdk-name }}. Например: `result[0]`.

    Объект `result` класса `TextMessage` представляет собой массив альтернатив, содержащихся в ответах модели. С помощью такого объекта можно передать предыдущий ответ модели в последующем запросе.
* Массив, содержащий любое сочетание указанных выше типов данных. Например: `["text", {"role": "role", "text": "text"}]`.

Пример ниже отправит в модель {{ gpt-pro }} запрос c промтом в форме строки «Что такое небо?».

```python
from yandex_cloud_ml_sdk import YCloudML

sdk = YCloudML(
    folder_id="<идентификатор_каталога>",
    auth="<аутентификационные_данные>",
)

model = sdk.models.completions("yandexgpt")
model = model.configure(temperature=0.5)
result = model.run("Что такое небо?")

print(f'{result=}')

print(f'{result[0]=}')

print(f'{result.alternatives[0].role=}')

print(f'{result.alternatives[0].text=}')

print(f'{result.alternatives[0].status=}')
```

Где:

* `folder_id` — [идентификатор каталога](../../resource-manager/operations/folder/get-id.md), в котором создан [сервисный аккаунт](../../iam/concepts/users/service-accounts.md).
* `auth` — ключ, токен или другие данные для [аутентификации](#authentication), позволяющие идентифицировать субъекта.

Результат:

1. Переменная `result` содержит массив альтернатив, содержащихся в ответах модели:

    ```text
    GPTModelResult(alternatives=(Alternative(role='assistant', text='Небо — это пространство над поверхностью Земли или другой планеты, которое мы видим, когда смотрим вверх. Оно может быть ясным и безоблачным, облачным или пасмурным, а ночью на нём появляются звёзды, луна и другие небесные тела.\n\nТакже слово «небо» может использоваться в переносном смысле, обозначая не только физическое пространство, но и нечто возвышенное, идеальное или божественное.', status=<AlternativeStatus.FINAL: 3>),), usage=Usage(input_text_tokens=14, completion_tokens=83, total_tokens=97), model_version='23.10.2024')
    ```

1. Элемент массива `result[0]` содержит объект `result.alternatives[0]` [класса](https://github.com/yandex-cloud/yandex-cloud-ml-sdk/blob/master/src/yandex_cloud_ml_sdk/_models/completions/message.py) `TextMessage` {{ ml-sdk-name }}, который в свою очередь содержит поля `role`, `text` и `status`:

    ```text
    Alternative(role='assistant', text='Небо — это пространство над поверхностью Земли или другой планеты, которое мы видим, когда смотрим вверх. Оно может быть ясным и безоблачным, облачным или пасмурным, а ночью на нём появляются звёзды, луна и другие небесные тела.\n\nТакже слово «небо» может использоваться в переносном смысле, обозначая не только физическое пространство, но и нечто возвышенное, идеальное или божественное.', status=<AlternativeStatus.FINAL: 3>)
    ```
1. Поле `result.alternatives[0].role` содержит одно из значений роли отправителя сообщения:

    * `user` — предназначена для отправки пользовательских сообщений к модели.
    * `system` — позволяет задать контекст запроса и определить поведение модели.
    * `assistant` — используется для ответов, которые генерирует модель.

    ```text
    assistant
    ```
1. Поле `result.alternatives[0].text` содержит текст сообщения:

    ```text
    Небо — это пространство над поверхностью Земли или другой планеты, которое мы видим, когда смотрим вверх. Оно может быть ясным и безоблачным, облачным или пасмурным, а ночью на нём появляются звёзды, луна и другие небесные тела.
    
    Также слово «небо» может использоваться в переносном смысле, обозначая не только физическое пространство, но и нечто возвышенное, идеальное или божественное.
    ```
1. Поле `result.alternatives[0].status` содержит статус сообщения. Возможные значения статуса:

    * `UNSPECIFIED` — статус не определен.
    * `PARTIAL` — часть сгенерированного текста, который может измениться в ходе дальнейшей генерации.
    * `TRUNCATED_FINAL` — итоговый сгенерированный текст, но результат превышает установленные ограничения.
    * `FINAL` — итоговый сгенерированный текст в пределах установленных ограничений.
    * `CONTENT_FILTER` — генерация остановлена из-за наличия конфиденциальных данных или этически ненадлежащих тем в промте или сгенерированном тексте.

    ```text
    AlternativeStatus.FINAL: 3
    ```

Дополнительные примеры использования {{ ml-sdk-name }} см. в [пошаговых инструкциях для {{ foundation-models-full-name }}](../operations/index.md).