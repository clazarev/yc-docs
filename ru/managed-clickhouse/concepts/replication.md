---
title: Репликация в {{ mch-full-name }}
description: Из статьи вы узнаете, как работает репликация хостов кластера в {{ mch-full-name }}.
---

# Репликация в {{ mch-name }}

Репликация в {{ CH }} осуществляется, если в кластере одновременно выполняются следующие условия:

* существует хотя бы один шард с двумя или более хостами;
* настроен механизм координации между хостами.

Кластер {{ mch-name }}, в котором функционирует репликация, считается отказоустойчивым. В таком кластере доступно создание [реплицируемых таблиц](#replicated-tables) и [реплицируемых баз данных](#replicated-db).

Для координации хостов и распределения запросов между ними {{ mch-name }} позволяет использовать один из следующих механизмов:

* [{{ CK }}](#ck);
* [{{ ZK }}](#zk) (по умолчанию).

## {{ CK }} {#ck}

{% include [ClickHouse Keeper preview note](../../_includes/mdb/mch/note-ck-preview.md) %}

{{ CK }} — сервис для репликации данных и выполнения распределенных DDL-запросов, реализующий совместимый с {{ ZK }} клиент-серверный протокол. В отличие от {{ ZK }}, {{ CK }} не требует для своей работы отдельных хостов, а выполняется на хостах {{ CH }}. Включить поддержку {{ CK }} можно только при [создании кластера](../operations/cluster-create.md).

Использование {{ CK }} накладывает следующие ограничения:

* Можно создавать кластеры только из трех или более хостов.
* Поддержку {{ CK }} нельзя включить или выключить после создания кластера.
* Кластеры, использующие хосты {{ ZK }}, нельзя перевести на использование {{ CK }}.
* [Перенести хост](../operations/host-migration.md) c {{ CK }} в другую зону доступности можно только через обращение в [службу поддержки]({{ link-console-support }}).

Подробнее о {{ CK }} см. в [документации {{ CH }}]({{ ch.docs }}/operations/clickhouse-keeper/).

## {{ ZK }} {#zk}

{{ ZK }} — это сервис, который обеспечивает координацию и распределение запросов между хостами {{ CH }}. Для обеспечения репликации в кластере {{ mch-name }} должно быть [три или пять хостов {{ ZK }}](../qa/cluster-settings.md#zookeeper-hosts-number).

Если кластер состоит из одного хоста {{ CH }} или нескольких однохостовых шардов и был создан без поддержки {{ CK }}, перед добавлением новых хостов нужно обеспечить его отказоустойчивость. Для этого [добавьте в кластер три или пять хостов {{ ZK }}](../operations/zk-hosts.md#add-zk). Если в кластере уже есть хосты {{ ZK }}, вы можете [добавлять хосты {{ CH }}](../operations/hosts.md#add-host) к любым шардам.


Если вы создаете кластер с двумя или более хостами {{ CH }} на шард, в кластер автоматически добавятся три хоста {{ ZK }}. При создании вы можете настроить только их конфигурацию с учетом следующих особенностей:

* Если в [виртуальной сети](../../vpc/concepts/network.md) для кластера есть подсети в каждой из [зон доступности](../../overview/concepts/geo-scope.md), то в каждую подсеть автоматически будет добавлено по одному хосту {{ ZK }}, если не указать настройки этих хостов явно. При необходимости можно явно указать три хоста {{ ZK }} и их настройки при создании кластера.
* Если в виртуальной сети для кластера есть подсети только в некоторых зонах доступности, то нужно явно указать три хоста {{ ZK }} и их настройки при создании кластера.

* Если вы не указали подсети для этих хостов, {{ mch-short-name }} автоматически распределит их по подсетям той сети, к которой подключен кластер {{ CH }}.


Минимальное количество ядер для одного хоста {{ ZK }} зависит от суммарного количества ядер хостов {{ CH }}:

| Суммарное количество ядер хостов {{ CH }} | Минимальное количество ядер для одного хоста {{ ZK }} |
|-------------------------------------------|-------------------------------------------------------|
| Менее 48                                  | 2                                                     |
| 48 и более                                | 4                                                     |

Класс хостов и размер хранилища {{ ZK }} можно изменить при [изменении настроек кластера](../operations/update.md#change-resource-preset). Изменить настройки {{ ZK }} или подключиться к его хостам нельзя.

{% note warning %}

Хосты {{ ZK }}, если они есть, учитываются при расчете [потребления ресурсов]({{ link-console-quotas }}) и стоимости кластера.

{% endnote %}

## Реплицируемые таблицы {#replicated-tables}

{{ CH }} поддерживает автоматическую репликацию только для таблиц на [движке семейства ReplicatedMergeTree]({{ ch.docs }}/engines/table-engines/mergetree-family/replication/). Чтобы обеспечить репликацию, вы можете создать такие таблицы на каждом хосте по отдельности или использовать распределенный DDL-запрос.

{% note warning %}

Рекомендуется создавать реплицируемые таблицы на всех хостах кластера, иначе может произойти потеря данных после восстановления кластера из [резервной копии](backup.md) или [миграции хостов кластера](../operations/host-migration.md) в другую зону доступности.

{% endnote %}

Чтобы создать таблицу `ReplicatedMergeTree` на определенном хосте {{ CH }}, отправьте запрос следующего вида:

```sql
CREATE TABLE db_01.table_01 (
    log_date date,
    user_name String) ENGINE = ReplicatedMergeTree ('/table_01', '{replica}'
)
PARTITION BY log_date
ORDER BY
    (log_date, user_name);
```

Здесь:

* `db_01` — имя базы данных.
* `table_01` — имя таблицы.
* `/table_01` — путь к таблице в {{ ZK }} или {{ CK }}, обязательно должен начинаться с прямого слэша `/`.
* `{replica}` — макроподстановка идентификатора хоста.

Чтобы создать реплицируемые таблицы на всех хостах кластера, отправьте [распределенный DDL-запрос]({{ ch.docs }}/sql-reference/distributed-ddl/):

```sql
CREATE TABLE db_01.table_01 ON CLUSTER '{cluster}' (
    log_date date,
    user_name String) ENGINE = ReplicatedMergeTree ('/table_01', '{replica}'
)
PARTITION BY log_date
ORDER BY
    (log_date, user_name);
```

Аргумент `'{cluster}'` автоматически разрешится в идентификатор кластера {{ CH }}.

Об организации взаимодействия реплицированных и распределенных таблиц в кластере {{ CH }} см. в разделе [Шардирование](sharding.md).

## Реплицируемые базы данных {#replicated-db}

В {{ CH }} при [создании базы данных](../operations/databases.md#add-db) можно выбрать движок Replicated. Он обеспечивает репликацию метаданных таблиц между всеми репликами базы данных. При этом набор таблиц и их схемы будут одинаковыми для всех реплик.

Движок задается при создании базы данных и не может быть изменен для этой базы.

## Примеры использования {#examples}

* [{#T}](../tutorials/rdbms-to-clickhouse.md)
* [{#T}](../tutorials/ydb-to-clickhouse.md)
* [{#T}](../tutorials/object-storage-to-clickhouse.md)
* [{#T}](../tutorials/mysql-to-clickhouse.md)

{% include [clickhouse-disclaimer](../../_includes/clickhouse-disclaimer.md) %}
